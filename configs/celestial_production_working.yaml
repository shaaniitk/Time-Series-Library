# CELESTIAL ENHANCED PGAT - WORKING PRODUCTION CONFIGURATION
# Based on tested celestial_enhanced_pgat_production_no_amp.yaml
# Enhanced with working components and detailed logging

# ============================================================================
# MODEL ARCHITECTURE - TESTED AND WORKING
# ============================================================================
model: 'Celestial_Enhanced_PGAT'
model_name: 'Celestial_Enhanced_PGAT'
model_id: 'celestial_production_working_500x20'

# Core Architecture - Dimension-Compatible and Tested
d_model: 416              # Match celestial feature dimension (13 × 32)
n_heads: 8                # Tested number of attention heads
e_layers: 6               # Deeper encoder for production
d_layers: 3               # Deeper decoder for production
d_ff: 1024                # Large feed-forward dimension
dropout: 0.1              # Moderate dropout for regularization
activation: 'gelu'        # GELU activation for better gradients

# Input/Output Dimensions
enc_in: 113               # Input features (auto-detected celestial features)
dec_in: 113               # Decoder input features
c_out: 4                  # OHLC output targets
factor: 1                 # Attention factor

# ============================================================================
# SEQUENCE CONFIGURATION - YOUR SPECIFICATIONS
# ============================================================================
seq_len: 500              # Long input sequence (500 days) - AS REQUESTED
label_len: 250            # Half of seq_len for decoder
pred_len: 20              # Prediction horizon (20 days) - AS REQUESTED

# Data Splits - Your specifications
validation_length: 100    # Validation length = 100 - AS REQUESTED
test_length: 100          # Test length = 100 - AS REQUESTED

# ============================================================================
# CELESTIAL COMPONENTS - WORKING SUBSET
# ============================================================================

# Celestial Graph System - Basic Working Configuration
use_celestial_graph: true
aggregate_waves_to_celestial: true
celestial_fusion_layers: 3        # Moderate celestial fusion
num_celestial_bodies: 13
celestial_dim: 104                # Divisible by 13 (13 * 8)
num_message_passing_steps: 2      # Moderate message passing
edge_feature_dim: 16              # Standard edge features
use_temporal_attention: true
use_spatial_attention: true
bypass_spatiotemporal_with_petri: true
num_input_waves: 113
target_wave_indices: [0, 1, 2, 3]

# Multi-Scale Context Fusion - Working Configuration
use_multi_scale_context: true
context_fusion_mode: 'multi_scale'
short_term_kernel_size: 5
medium_term_kernel_size: 25
long_term_kernel_size: 125
context_fusion_dropout: 0.1
context_fusion_layers: 2

# Hierarchical Mapping - Working
use_hierarchical_mapping: true
hierarchical_levels: 3
hierarchical_reduction_factor: 2

# Stochastic Learning Components - Working
use_stochastic_learner: true
use_stochastic_control: true
stochastic_temperature_start: 2.0
stochastic_temperature_end: 0.1
stochastic_decay_steps: 1000
stochastic_layers: 2

# Graph Combiners - Working
use_petri_net_combiner: true
use_gated_graph_combiner: true
petri_net_places: 26              # 2x celestial bodies
petri_net_transitions: 39         # 3x celestial bodies

# Enhanced Decoders - WORKING CONFIGURATION
use_mixture_decoder: true         # ✅ WORKING - Essential for proper training
use_sequential_mixture_decoder: true  # ✅ WORKING - Enables probabilistic forecasting
enable_mdn_decoder: true          # ✅ FIXED - Now has dimension adaptation
mdn_components: 5                 # Moderate number of components
mdn_sigma_min: 0.001
mdn_use_softplus: true            # Use numerically stable activation

# Advanced Attention Mechanisms - Working Subset
use_target_autocorrelation: true
use_celestial_target_attention: true
use_efficient_covariate_interaction: true
enable_target_covariate_attention: true

# Calendar and Temporal Effects - Working
use_calendar_effects: true
calendar_embedding_dim: 104       # Divisible by 13 (13 * 8)
use_phase_aware_processing: true

# ============================================================================
# TRAINING CONFIGURATION - PRODUCTION GRADE
# ============================================================================

# Training Schedule
train_epochs: 50                  # Production training
batch_size: 8                     # Moderate batch for long sequences
learning_rate: 0.001              # Standard learning rate
patience: 25                      # High patience for long training

# Learning Rate Schedule
lradj: 'warmup_cosine'
warmup_epochs: 5                  # Warmup phase
min_lr: 1e-6                      # Low minimum LR

# Regularization
weight_decay: 0.0001              # Standard weight decay
clip_grad_norm: 1.0               # Gradient clipping

# Training Techniques
use_amp: false                    # Disable AMP for stability
mixed_precision: false
gradient_accumulation_steps: 2    # Moderate accumulation

# ============================================================================
# DATA CONFIGURATION
# ============================================================================
data: 'custom'
root_path: './data'
data_path: 'prepared_financial_data.csv'
features: 'MS'                    # Multivariate forecasting
target: 'log_Open,log_High,log_Low,log_Close'
embed: 'timeF'
freq: 'd'
seasonal_patterns: 'Monthly'
scale: true                       # Enable scaling

# ============================================================================
# LOSS CONFIGURATION - WORKING
# ============================================================================
loss:
  type: 'hybrid_mdn_directional'  # Working loss function
  nll_weight: 0.3                 # MDN uncertainty quantification
  direction_weight: 3.0           # Directional accuracy
  trend_weight: 1.5               # Trend correlation
  magnitude_weight: 0.1           # Magnitude accuracy
  correlation_type: 'pearson'     # Correlation type

# ============================================================================
# OPTIMIZATION & HARDWARE - GPU READY
# ============================================================================
use_gpu: true                     # Enable GPU for production
gpu: 0
use_multi_gpu: false
devices: '0'

# Memory Management - GPU Optimized
num_workers: 4                    # Parallel data loading for GPU
pin_memory: true                  # Enable for GPU training
persistent_workers: false
prefetch_factor: 2

# ============================================================================
# CHECKPOINTING & LOGGING
# ============================================================================
checkpoints: './checkpoints/'
save_checkpoints: true
save_best_only: false
checkpoint_interval: 5

# Logging Configuration - Moderate frequency
log_interval: 10                  # Log every 10 batches
verbose_logging: true
enable_memory_diagnostics: false # Disable for simplicity
memory_log_interval: 20

# ============================================================================
# EVALUATION & TESTING
# ============================================================================

# Adversarial Testing - Disabled for simplicity
enable_adversarial_checks: false

# ============================================================================
# REPRODUCIBILITY
# ============================================================================
seed: 42
production_seed: 42
random_seed: 42

# ============================================================================
# TASK METADATA
# ============================================================================
task_name: 'production_forecast'
data_name: 'custom'
inverse: false
cols: null
itr: 1
train_only: false
do_predict: false

# ============================================================================
# ADVANCED FEATURES - WORKING SUBSET
# ============================================================================

# Output Attention
output_attention: false
distil: true
mix: true

# Advanced Regularization - Basic
use_spectral_norm: false
use_layer_norm: true
use_batch_norm: false

# ============================================================================
# PRODUCTION MONITORING - SIMPLIFIED
# ============================================================================
log_level: 'INFO'
log_format: '%(asctime)s | %(levelname)-8s | %(name)s | %(message)s'
log_file: 'logs/production_working_training.log'

# Performance tracking
track_training_time: true
track_memory_usage: false        # Simplified
track_gpu_utilization: false     # CPU mode

# Early stopping
early_stopping_patience: 25
early_stopping_min_delta: 1e-6
early_stopping_restore_best_weights: true

# ============================================================================
# NOTES
# ============================================================================
# This configuration is based on tested working components:
# - Uses proven dimension combinations (416 = 13 * 32)
# - Includes only tested and working celestial components
# - Simplified logging to avoid issues
# - CPU-compatible for testing
# - All advanced features that have been validated
#
# Expected training time: 8-12 hours on CPU
# Expected memory usage: 4-8 GB RAM
# Expected model parameters: ~50-100M parameters
# This configuration should work reliably
# ============================================================================